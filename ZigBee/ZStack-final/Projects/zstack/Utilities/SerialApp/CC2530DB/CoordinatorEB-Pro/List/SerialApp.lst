###############################################################################
#                                                                             #
# IAR C/C++ Compiler V8.10.3.10338/W32 for 8051         12/Jun/2016  11:58:49 #
# Copyright 2004-2011 IAR Systems AB.                                         #
#                                                                             #
#    Core               =  plain                                              #
#    Code model         =  banked                                             #
#    Data model         =  large                                              #
#    Calling convention =  xdata reentrant                                    #
#    Constant location  =  data_rom                                           #
#    Dptr setup         =  1,16                                               #
#    Source file        =  E:\CollegeCourse\ThDSemester-2\EmbeddedSystem\ZigB #
#                          ee\ZStack-final\Projects\zstack\Utilities\SerialAp #
#                          p\Source\SerialApp.c                               #
#    Command line       =  -f E:\CollegeCourse\ThDSemester-2\EmbeddedSystem\Z #
#                          igBee\ZStack-final\Projects\zstack\Utilities\Seria #
#                          lApp\CC2530DB\..\..\..\Tools\CC2530DB\f8wCoord.cfg #
#                           (-DCPU32MHZ -DROOT=__near_func                    #
#                          -DMAC_CFG_APP_PENDING_QUEUE=TRUE                   #
#                          -DZDO_COORDINATOR -DRTR_NWK -DBLINK_LEDS) -f       #
#                          E:\CollegeCourse\ThDSemester-2\EmbeddedSystem\ZigB #
#                          ee\ZStack-final\Projects\zstack\Utilities\SerialAp #
#                          p\CC2530DB\..\..\..\Tools\CC2530DB\f8wConfig.cfg   #
#                          (-DSECURE=0 -DZG_SECURE_DYNAMIC=0 -DREFLECTOR      #
#                          -DDEFAULT_CHANLIST=0x00000800                      #
#                          -DZDAPP_CONFIG_PAN_ID=0x1223                       #
#                          -DNWK_START_DELAY=100 -DEXTENDED_JOINING_RANDOM_MA #
#                          SK=0x007F -DBEACON_REQUEST_DELAY=100               #
#                          -DBEACON_REQ_DELAY_MASK=0x00FF                     #
#                          -DROUTE_EXPIRY_TIME=30 -DAPSC_ACK_WAIT_DURATION_PO #
#                          LLED=3000 -DNWK_INDIRECT_MSG_TIMEOUT=7             #
#                          -DMAX_RREQ_ENTRIES=8 -DAPSC_MAX_FRAME_RETRIES=3    #
#                          -DNWK_MAX_DATA_RETRIES=2                           #
#                          -DMAX_POLL_FAILURE_RETRIES=2 -DMAX_BCAST=9         #
#                          -DAPS_MAX_GROUPS=16 -DMAX_RTG_ENTRIES=40           #
#                          -DNWK_MAX_BINDING_ENTRIES=4                        #
#                          -DMAX_BINDING_CLUSTER_IDS=4 "-DDEFAULT_KEY={0x01,  #
#                          0x03, 0x05, 0x07, 0x09, 0x0B, 0x0D, 0x0F, 0x00,    #
#                          0x02, 0x04, 0x06, 0x08, 0x0A, 0x0C, 0x0D}"         #
#                          -DMAC_MAX_FRAME_SIZE=116 "-DCONST=const __code"    #
#                          -DGENERIC=__generic -DRFD_RCVC_ALWAYS_ON=FALSE     #
#                          -DPOLL_RATE=1000 -DQUEUED_POLL_RATE=100            #
#                          -DRESPONSE_POLL_RATE=100) -DREJOIN_POLL_RATE=440   #
#                          E:\CollegeCourse\ThDSemester-2\EmbeddedSystem\ZigB #
#                          ee\ZStack-final\Projects\zstack\Utilities\SerialAp #
#                          p\Source\SerialApp.c -D ZIGBEEPRO -D               #
#                          HAL_UART=TRUE -D SERIAL_APP_PORT=0 -D              #
#                          LCD_SUPPORTED -lC E:\CollegeCourse\ThDSemester-2\E #
#                          mbeddedSystem\ZigBee\ZStack-final\Projects\zstack\ #
#                          Utilities\SerialApp\CC2530DB\CoordinatorEB-Pro\Lis #
#                          t\ -lA E:\CollegeCourse\ThDSemester-2\EmbeddedSyst #
#                          em\ZigBee\ZStack-final\Projects\zstack\Utilities\S #
#                          erialApp\CC2530DB\CoordinatorEB-Pro\List\          #
#                          --diag_suppress Pe001,Pa010 -o                     #
#                          E:\CollegeCourse\ThDSemester-2\EmbeddedSystem\ZigB #
#                          ee\ZStack-final\Projects\zstack\Utilities\SerialAp #
#                          p\CC2530DB\CoordinatorEB-Pro\Obj\ -e --debug       #
#                          --core=plain --dptr=16,1 --data_model=large        #
#                          --code_model=banked --calling_convention=xdata_ree #
#                          ntrant --place_constants=data_rom                  #
#                          --nr_virtual_regs 8 -I E:\CollegeCourse\ThDSemeste #
#                          r-2\EmbeddedSystem\ZigBee\ZStack-final\Projects\zs #
#                          tack\Utilities\SerialApp\CC2530DB\ -I              #
#                          E:\CollegeCourse\ThDSemester-2\EmbeddedSystem\ZigB #
#                          ee\ZStack-final\Projects\zstack\Utilities\SerialAp #
#                          p\CC2530DB\..\SOURCE\ -I                           #
#                          E:\CollegeCourse\ThDSemester-2\EmbeddedSystem\ZigB #
#                          ee\ZStack-final\Projects\zstack\Utilities\SerialAp #
#                          p\CC2530DB\..\..\..\ZMAIN\TI2530DB\ -I             #
#                          E:\CollegeCourse\ThDSemester-2\EmbeddedSystem\ZigB #
#                          ee\ZStack-final\Projects\zstack\Utilities\SerialAp #
#                          p\CC2530DB\..\..\..\..\..\COMPONENTS\MT\ -I        #
#                          E:\CollegeCourse\ThDSemester-2\EmbeddedSystem\ZigB #
#                          ee\ZStack-final\Projects\zstack\Utilities\SerialAp #
#                          p\CC2530DB\..\..\..\..\..\COMPONENTS\HAL\INCLUDE\  #
#                          -I E:\CollegeCourse\ThDSemester-2\EmbeddedSystem\Z #
#                          igBee\ZStack-final\Projects\zstack\Utilities\Seria #
#                          lApp\CC2530DB\..\..\..\..\..\COMPONENTS\HAL\TARGET #
#                          \CC2530EB\ -I E:\CollegeCourse\ThDSemester-2\Embed #
#                          dedSystem\ZigBee\ZStack-final\Projects\zstack\Util #
#                          ities\SerialApp\CC2530DB\..\..\..\..\..\COMPONENTS #
#                          \OSAL\MCU\CCSOC\ -I E:\CollegeCourse\ThDSemester-2 #
#                          \EmbeddedSystem\ZigBee\ZStack-final\Projects\zstac #
#                          k\Utilities\SerialApp\CC2530DB\..\..\..\..\..\COMP #
#                          ONENTS\OSAL\INCLUDE\ -I E:\CollegeCourse\ThDSemest #
#                          er-2\EmbeddedSystem\ZigBee\ZStack-final\Projects\z #
#                          stack\Utilities\SerialApp\CC2530DB\..\..\..\..\..\ #
#                          COMPONENTS\STACK\AF\ -I E:\CollegeCourse\ThDSemest #
#                          er-2\EmbeddedSystem\ZigBee\ZStack-final\Projects\z #
#                          stack\Utilities\SerialApp\CC2530DB\..\..\..\..\..\ #
#                          COMPONENTS\STACK\NWK\ -I                           #
#                          E:\CollegeCourse\ThDSemester-2\EmbeddedSystem\ZigB #
#                          ee\ZStack-final\Projects\zstack\Utilities\SerialAp #
#                          p\CC2530DB\..\..\..\..\..\COMPONENTS\STACK\SEC\    #
#                          -I E:\CollegeCourse\ThDSemester-2\EmbeddedSystem\Z #
#                          igBee\ZStack-final\Projects\zstack\Utilities\Seria #
#                          lApp\CC2530DB\..\..\..\..\..\COMPONENTS\STACK\SAPI #
#                          \ -I E:\CollegeCourse\ThDSemester-2\EmbeddedSystem #
#                          \ZigBee\ZStack-final\Projects\zstack\Utilities\Ser #
#                          ialApp\CC2530DB\..\..\..\..\..\COMPONENTS\STACK\SY #
#                          S\ -I E:\CollegeCourse\ThDSemester-2\EmbeddedSyste #
#                          m\ZigBee\ZStack-final\Projects\zstack\Utilities\Se #
#                          rialApp\CC2530DB\..\..\..\..\..\COMPONENTS\STACK\Z #
#                          DO\ -I E:\CollegeCourse\ThDSemester-2\EmbeddedSyst #
#                          em\ZigBee\ZStack-final\Projects\zstack\Utilities\S #
#                          erialApp\CC2530DB\..\..\..\..\..\COMPONENTS\ZMAC\F #
#                          8W\ -I E:\CollegeCourse\ThDSemester-2\EmbeddedSyst #
#                          em\ZigBee\ZStack-final\Projects\zstack\Utilities\S #
#                          erialApp\CC2530DB\..\..\..\..\..\COMPONENTS\ZMAC\  #
#                          -I E:\CollegeCourse\ThDSemester-2\EmbeddedSystem\Z #
#                          igBee\ZStack-final\Projects\zstack\Utilities\Seria #
#                          lApp\CC2530DB\..\..\..\..\..\COMPONENTS\SERVICES\S #
#                          ADDR\ -I E:\CollegeCourse\ThDSemester-2\EmbeddedSy #
#                          stem\ZigBee\ZStack-final\Projects\zstack\Utilities #
#                          \SerialApp\CC2530DB\..\..\..\..\..\COMPONENTS\SERV #
#                          ICES\SDATA\ -I E:\CollegeCourse\ThDSemester-2\Embe #
#                          ddedSystem\ZigBee\ZStack-final\Projects\zstack\Uti #
#                          lities\SerialApp\CC2530DB\..\..\..\..\..\COMPONENT #
#                          S\MAC\INCLUDE\ -I E:\CollegeCourse\ThDSemester-2\E #
#                          mbeddedSystem\ZigBee\ZStack-final\Projects\zstack\ #
#                          Utilities\SerialApp\CC2530DB\..\..\..\..\..\COMPON #
#                          ENTS\MAC\HIGH_LEVEL\ -I E:\CollegeCourse\ThDSemest #
#                          er-2\EmbeddedSystem\ZigBee\ZStack-final\Projects\z #
#                          stack\Utilities\SerialApp\CC2530DB\..\..\..\..\..\ #
#                          COMPONENTS\MAC\LOW_LEVEL\srf04\ -I                 #
#                          E:\CollegeCourse\ThDSemester-2\EmbeddedSystem\ZigB #
#                          ee\ZStack-final\Projects\zstack\Utilities\SerialAp #
#                          p\CC2530DB\..\..\..\..\..\COMPONENTS\MAC\LOW_LEVEL #
#                          \srf04\SINGLE_CHIP\ -Ohz --require_prototypes      #
#    List file          =  E:\CollegeCourse\ThDSemester-2\EmbeddedSystem\ZigB #
#                          ee\ZStack-final\Projects\zstack\Utilities\SerialAp #
#                          p\CC2530DB\CoordinatorEB-Pro\List\SerialApp.lst    #
#    Object file        =  E:\CollegeCourse\ThDSemester-2\EmbeddedSystem\ZigB #
#                          ee\ZStack-final\Projects\zstack\Utilities\SerialAp #
#                          p\CC2530DB\CoordinatorEB-Pro\Obj\SerialApp.r51     #
#                                                                             #
#                                                                             #
###############################################################################

E:\CollegeCourse\ThDSemester-2\EmbeddedSystem\ZigBee\ZStack-final\Projects\zstack\Utilities\SerialApp\Source\SerialApp.c
      1          /*********************************************************************
      2           * INCLUDES
      3           */
      4          
      5          #include <stdio.h>
      6          #include <string.h>
      7          #include "AF.h"
      8          #include "OnBoard.h"
      9          #include "OSAL_Tasks.h"
     10          #include "SerialApp.h"
     11          #include "ZDApp.h"
     12          #include "ZDObject.h"
     13          #include "ZDProfile.h"
     14          
     15          #include "hal_drivers.h"
     16          #include "hal_key.h"
     17          #if defined ( LCD_SUPPORTED )
     18            #include "hal_lcd.h"
     19          #endif
     20          #include "hal_led.h"
     21          #include "hal_uart.h"
     22          
     23          /*********************************************************************
     24           * MACROS
     25           */
     26          
     27          /*********************************************************************
     28           * CONSTANTS
     29           */
     30          
     31          #if !defined( SERIAL_APP_PORT )
     32          #define SERIAL_APP_PORT  0
     33          #endif
     34          
     35          #if !defined( SERIAL_APP_BAUD )
     36            //#define SERIAL_APP_BAUD  HAL_UART_BR_38400
     37            #define SERIAL_APP_BAUD  HAL_UART_BR_38400
     38          #endif
     39          
     40          // When the Rx buf space is less than this threshold, invoke the Rx callback.
     41          #if !defined( SERIAL_APP_THRESH )
     42          #define SERIAL_APP_THRESH  64
     43          #endif
     44          
     45          #if !defined( SERIAL_APP_RX_SZ )
     46          #define SERIAL_APP_RX_SZ  128
     47          #endif
     48          
     49          #if !defined( SERIAL_APP_TX_SZ )
     50          #define SERIAL_APP_TX_SZ  128
     51          #endif
     52          
     53          // Millisecs of idle time after a byte is received before invoking Rx callback.
     54          #if !defined( SERIAL_APP_IDLE )
     55          #define SERIAL_APP_IDLE  6
     56          #endif
     57          
     58          // Loopback Rx bytes to Tx for throughput testing.
     59          #if !defined( SERIAL_APP_LOOPBACK )
     60          #define SERIAL_APP_LOOPBACK  FALSE
     61          #endif
     62          
     63          // This is the max byte count per OTA message.
     64          #if !defined( SERIAL_APP_TX_MAX )
     65          #define SERIAL_APP_TX_MAX  80
     66          #endif
     67          
     68          #define SERIAL_APP_RSP_CNT  4
     69          
     70          // This list should be filled with Application specific Cluster IDs.

   \                                 In  segment XDATA_ROM_C, align 1
     71          const cId_t SerialApp_ClusterList[SERIALAPP_MAX_CLUSTERS] =
   \                     SerialApp_ClusterList:
   \   000000   0100         DW 1
   \   000002   0200         DW 2
   \   000004   0300         DW 3
   \   000006   0400         DW 4
     72          {
     73            SERIALAPP_CLUSTERID1,
     74            SERIALAPP_CLUSTERID2,
     75            SERIALAPP_CONNECTREQ_CLUSTER,            
     76            SERIALAPP_CONNECTRSP_CLUSTER             
     77          };
     78          

   \                                 In  segment XDATA_ROM_C, align 1
     79          const SimpleDescriptionFormat_t SerialApp_SimpleDesc =
   \                     SerialApp_SimpleDesc:
   \   000000   01           DB 1
   \   000001   050F         DW 3845
   \   000003   0100         DW 1
   \   000005   00           DB 0
   \   000006   04           DB 4
   \   000007   ....         DW SerialApp_ClusterList
   \   000009   04           DB 4
   \   00000A   ....         DW SerialApp_ClusterList
     80          {
     81          #if ZDO_COORDINATOR
     82            SERIALAPP_COORPOINT,
     83          #else
     84            SERIALAPP_ENDPOINT,              //  int   Endpoint;
     85          #endif
     86            SERIALAPP_PROFID,                //  uint16 AppProfId[2];
     87            SERIALAPP_DEVICEID,              //  uint16 AppDeviceId[2];
     88            SERIALAPP_DEVICE_VERSION,        //  int   AppDevVer:4;
     89            SERIALAPP_FLAGS,                 //  int   AppFlags:4;
     90            SERIALAPP_MAX_CLUSTERS,          //  byte  AppNumInClusters;
     91            (cId_t *)SerialApp_ClusterList,  //  byte *pAppInClusterList;
     92            SERIALAPP_MAX_CLUSTERS,          //  byte  AppNumOutClusters;
     93            (cId_t *)SerialApp_ClusterList   //  byte *pAppOutClusterList;
     94          };
     95          

   \                                 In  segment XDATA_I, align 1, keep-with-next
     96          endPointDesc_t SerialApp_epDesc =
   \                     SerialApp_epDesc:
   \   000000                DS 6
   \   000006                REQUIRE `?<Initializer for SerialApp_epDesc>`
   \   000006                REQUIRE __INIT_XDATA_I
     97          {
     98          #if ZDO_COORDINATOR
     99            SERIALAPP_COORPOINT,
    100          #else
    101            SERIALAPP_ENDPOINT,              //  int   Endpoint;
    102          #endif
    103           &SerialApp_TaskID,
    104            (SimpleDescriptionFormat_t *)&SerialApp_SimpleDesc,
    105            noLatencyReqs
    106          };
    107          
    108          /*********************************************************************
    109           * TYPEDEFS
    110           */
    111          
    112          /*********************************************************************
    113           * GLOBAL VARIABLES
    114           */

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    115          devStates_t SampleApp_NwkState;   
   \                     SampleApp_NwkState:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    116          uint8 SerialApp_TaskID;           // Task ID for internal task/event processing.
   \                     SerialApp_TaskID:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z
    117          
    118          /*********************************************************************
    119           * EXTERNAL VARIABLES
    120           */
    121          
    122          /*********************************************************************
    123           * EXTERNAL FUNCTIONS
    124           */
    125          
    126          /*********************************************************************
    127           * LOCAL VARIABLES
    128           */
    129          

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    130          static uint8 SerialApp_MsgID;
   \                     SerialApp_MsgID:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z
    131          

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    132          static afAddrType_t SerialApp_TxAddr;
   \                     SerialApp_TxAddr:
   \   000000                DS 12
   \   00000C                REQUIRE __INIT_XDATA_Z

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    133          static uint8 SerialApp_TxSeq;
   \                     SerialApp_TxSeq:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    134          static uint8 SerialApp_TxBuf[SERIAL_APP_TX_MAX+1];
   \                     SerialApp_TxBuf:
   \   000000                DS 81
   \   000051                REQUIRE __INIT_XDATA_Z

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    135          static uint8 SerialApp_TxLen;
   \                     SerialApp_TxLen:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z
    136          

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    137          static afAddrType_t SerialApp_RxAddr;
   \                     SerialApp_RxAddr:
   \   000000                DS 12
   \   00000C                REQUIRE __INIT_XDATA_Z

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    138          static uint8 SerialApp_RxSeq;
   \                     SerialApp_RxSeq:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    139          static uint8 SerialApp_RspBuf[SERIAL_APP_RSP_CNT];
   \                     SerialApp_RspBuf:
   \   000000                DS 4
   \   000004                REQUIRE __INIT_XDATA_Z
    140          
    141          /*********************************************************************
    142           * LOCAL FUNCTIONS
    143           */
    144          
    145          static void SerialApp_ProcessMSGCmd( afIncomingMSGPacket_t *pkt );
    146          static void SerialApp_Send(void);
    147          static void SerialApp_Resp(void);
    148          static void SerialApp_CallBack(uint8 port, uint8 event); 
    149          static void SerialApp_DeviceConnect(void);              
    150          static void SerialApp_DeviceConnectRsp(uint8*);         
    151          static void SerialApp_ConnectReqProcess(uint8*, uint8);           
    152          
    153          struct circleBuffer{
    154            uint8 buffer[10][40];
    155            uint8 eleSize[10];
    156            uint8 capacity;
    157            uint8 size;
    158            uint8 head;
    159            uint8 tail;
    160          };
    161          

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    162          struct circleBuffer cB;
   \                     cB:
   \   000000                DS 414
   \   00019E                REQUIRE __INIT_XDATA_Z
    163          
    164          static int circleBufferInit(void);
    165          static int circleBufferHasElement(void);
    166          static uint8* popElement(uint8* eleSize);
    167          static int pushElement(uint8* eleAddr, uint8 eleSize);
    168          static void send_uart(void);
    169          
    170          int circleBufferInit(void){
    171            cB.capacity=10;
    172            cB.size=0;
    173            cB.head=0;
    174            cB.tail=0;
    175            return 0;
    176          }
    177          
    178          int circleBufferHasElement(void){
    179            if(cB.size>0){
    180              return 1;
    181            }
    182            else{
    183              return 0;
    184            }
    185          }
    186          
    187          uint8* popElement(uint8* eleSize){
    188            uint8* returnAddress;
    189            if(cB.size<=0){
    190              *eleSize=0;
    191              return NULL;
    192            }
    193            else{
    194              *eleSize=cB.eleSize[cB.head];
    195              returnAddress=(uint8*)&cB.buffer[cB.head];
    196              cB.head++;
    197              if(cB.head==cB.capacity){
    198                cB.head=0; 
    199              }
    200              cB.size--;
    201              return returnAddress;
    202            }
    203          }
    204          
    205          int pushElement(uint8* eleAddr, uint8 eleSize){
    206            /*
    207            char buff[30] = {0};
    208            sprintf(buff,"push, %d, %d, %d.\n\r",cB.size, cB.capacity, eleSize);
    209            HalUARTWrite( SERIAL_APP_PORT, (uint8*)buff, strlen(buff));
    210            */
    211            if(cB.size==cB.capacity){
    212              return -1; 
    213            }
    214            else{
    215              osal_memcpy(cB.buffer[cB.tail],eleAddr,eleSize);
    216              cB.eleSize[cB.tail]=eleSize;
    217              cB.tail++;
    218              if(cB.tail==cB.capacity){
    219                cB.tail=0; 
    220              }
    221              cB.size++;
    222              osal_set_event( SerialApp_TaskID, SEND_UART );
    223              return 0;
    224            }
    225          }
    226          
    227          void send_uart(void){
    228            //char buff[30] = {0};
    229            uint8* buffer;
    230            uint8 size;
    231            if(circleBufferHasElement()==1){
    232              buffer=popElement(&size);
    233              //sprintf(buff,"send_uart, %p %d.\n\r",buffer,size);
    234              //HalUARTWrite( SERIAL_APP_PORT, (uint8*)buff, strlen(buff));
    235              HalUARTWrite( SERIAL_APP_PORT, buffer, size);
    236            }
    237            else{
    238              return;
    239            }
    240          }
    241          
    242          /*********************************************************************
    243           * @fn      SerialApp_Init
    244           *
    245           * @brief   This is called during OSAL tasks' initialization.
    246           *
    247           * @param   task_id - the Task ID assigned by OSAL.
    248           *
    249           * @return  none
    250           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    251          void SerialApp_Init( uint8 task_id )
   \                     SerialApp_Init:
    252          {
   \   000000   74F7         MOV     A,#-0x9
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 29
   \   000005   74E3         MOV     A,#-0x1d
   \   000007   12....       LCALL   ?ALLOC_XSTACK8
   \   00000A   E9           MOV     A,R1
   \   00000B   FE           MOV     R6,A
    253            halUARTCfg_t uartConfig;
    254          
    255            SerialApp_TaskID = task_id;
   \   00000C   90....       MOV     DPTR,#SerialApp_TaskID
   \   00000F   F0           MOVX    @DPTR,A
    256            SerialApp_RxSeq = 0xC3;
   \   000010   90....       MOV     DPTR,#SerialApp_RxSeq
   \   000013   74C3         MOV     A,#-0x3d
   \   000015   F0           MOVX    @DPTR,A
    257            SampleApp_NwkState = DEV_INIT;       
   \   000016   90....       MOV     DPTR,#SampleApp_NwkState
   \   000019   7401         MOV     A,#0x1
   \   00001B   F0           MOVX    @DPTR,A
    258            
    259            afRegister( (endPointDesc_t *)&SerialApp_epDesc );
   \   00001C                ; Setup parameters for call to function afRegister
   \   00001C   7A..         MOV     R2,#SerialApp_epDesc & 0xff
   \   00001E   7B..         MOV     R3,#(SerialApp_epDesc >> 8) & 0xff
   \   000020   12....       LCALL   ??afRegister?relay
    260          
    261            RegisterForKeys( task_id );
   \   000023                ; Setup parameters for call to function RegisterForKeys
   \   000023   EE           MOV     A,R6
   \   000024   F9           MOV     R1,A
   \   000025   12....       LCALL   ??RegisterForKeys?relay
    262          
    263            uartConfig.configured           = TRUE;              // 2x30 don't care - see uart driver.
   \   000028   85..82       MOV     DPL,?XSP + 0
   \   00002B   85..83       MOV     DPH,?XSP + 1
   \   00002E   7401         MOV     A,#0x1
   \   000030   F0           MOVX    @DPTR,A
    264            uartConfig.baudRate             = SERIAL_APP_BAUD;
   \   000031   12....       LCALL   ?XSTACK_DISP0_8
   \   000034   7402         MOV     A,#0x2
   \   000036   F0           MOVX    @DPTR,A
    265            uartConfig.flowControl          = FALSE;
   \   000037   12....       LCALL   ?XSTACK_DISP0_8
   \   00003A   E4           CLR     A
   \   00003B   F0           MOVX    @DPTR,A
    266            uartConfig.flowControlThreshold = SERIAL_APP_THRESH; // 2x30 don't care - see uart driver.
   \   00003C   7403         MOV     A,#0x3
   \   00003E   12....       LCALL   ?XSTACK_DISP0_8
   \   000041   7440         MOV     A,#0x40
   \   000043   F0           MOVX    @DPTR,A
   \   000044   A3           INC     DPTR
   \   000045   E4           CLR     A
   \   000046   F0           MOVX    @DPTR,A
    267            uartConfig.rx.maxBufSize        = SERIAL_APP_RX_SZ;  // 2x30 don't care - see uart driver.
   \   000047   740A         MOV     A,#0xa
   \   000049   12....       LCALL   ?XSTACK_DISP0_8
   \   00004C   7480         MOV     A,#-0x80
   \   00004E   F0           MOVX    @DPTR,A
   \   00004F   A3           INC     DPTR
   \   000050   E4           CLR     A
   \   000051   F0           MOVX    @DPTR,A
    268            uartConfig.tx.maxBufSize        = SERIAL_APP_TX_SZ;  // 2x30 don't care - see uart driver.
   \   000052   7412         MOV     A,#0x12
   \   000054   12....       LCALL   ?XSTACK_DISP0_8
   \   000057   7480         MOV     A,#-0x80
   \   000059   F0           MOVX    @DPTR,A
   \   00005A   A3           INC     DPTR
   \   00005B   E4           CLR     A
   \   00005C   F0           MOVX    @DPTR,A
    269            uartConfig.idleTimeout          = SERIAL_APP_IDLE;   // 2x30 don't care - see uart driver.
   \   00005D   7405         MOV     A,#0x5
   \   00005F   12....       LCALL   ?XSTACK_DISP0_8
   \   000062   7406         MOV     A,#0x6
   \   000064   F0           MOVX    @DPTR,A
    270            uartConfig.intEnable            = TRUE;              // 2x30 don't care - see uart driver.
   \   000065   7416         MOV     A,#0x16
   \   000067   12....       LCALL   ?XSTACK_DISP0_8
   \   00006A   7401         MOV     A,#0x1
   \   00006C   F0           MOVX    @DPTR,A
    271            uartConfig.callBackFunc         = SerialApp_CallBack;
   \   00006D   741B         MOV     A,#0x1b
   \   00006F   12....       LCALL   ?XSTACK_DISP0_8
   \   000072   74..         MOV     A,#??SerialApp_CallBack?relay & 0xff
   \   000074   F0           MOVX    @DPTR,A
   \   000075   A3           INC     DPTR
   \   000076   74..         MOV     A,#(??SerialApp_CallBack?relay >> 8) & 0xff
   \   000078   F0           MOVX    @DPTR,A
    272            HalUARTOpen (SERIAL_APP_PORT, &uartConfig);
   \   000079                ; Setup parameters for call to function HalUARTOpen
   \   000079   85..82       MOV     DPL,?XSP + 0
   \   00007C   85..83       MOV     DPH,?XSP + 1
   \   00007F   AA82         MOV     R2,DPL
   \   000081   AB83         MOV     R3,DPH
   \   000083   7900         MOV     R1,#0x0
   \   000085   12....       LCALL   ??HalUARTOpen?relay
    273          
    274          #if defined ( LCD_SUPPORTED )
    275            HalLcdWriteString( "SerialApp", HAL_LCD_LINE_2 );
   \   000088                ; Setup parameters for call to function HalLcdWriteString
   \   000088   7902         MOV     R1,#0x2
   \   00008A   7A..         MOV     R2,#`?<Constant "SerialApp">` & 0xff
   \   00008C   7B..         MOV     R3,#(`?<Constant "SerialApp">` >> 8) & 0xff
   \   00008E   12....       LCALL   ??HalLcdWriteString?relay
    276          #endif
    277            
    278            ZDO_RegisterForZDOMsg( SerialApp_TaskID, End_Device_Bind_rsp );
   \   000091                ; Setup parameters for call to function ZDO_RegisterForZDOMsg
   \   000091   7A20         MOV     R2,#0x20
   \   000093   7B80         MOV     R3,#-0x80
   \   000095   90....       MOV     DPTR,#SerialApp_TaskID
   \   000098   E0           MOVX    A,@DPTR
   \   000099   F9           MOV     R1,A
   \   00009A   12....       LCALL   ??ZDO_RegisterForZDOMsg?relay
    279            ZDO_RegisterForZDOMsg( SerialApp_TaskID, Match_Desc_rsp );
   \   00009D                ; Setup parameters for call to function ZDO_RegisterForZDOMsg
   \   00009D   7A06         MOV     R2,#0x6
   \   00009F   7B80         MOV     R3,#-0x80
   \   0000A1   90....       MOV     DPTR,#SerialApp_TaskID
   \   0000A4   E0           MOVX    A,@DPTR
   \   0000A5   F9           MOV     R1,A
   \   0000A6   12....       LCALL   ??ZDO_RegisterForZDOMsg?relay
    280            circleBufferInit();
   \   0000A9   90....       MOV     DPTR,#cB + 410
   \   0000AC   740A         MOV     A,#0xa
   \   0000AE   F0           MOVX    @DPTR,A
   \   0000AF   A3           INC     DPTR
   \   0000B0   E4           CLR     A
   \   0000B1   F0           MOVX    @DPTR,A
   \   0000B2   A3           INC     DPTR
   \   0000B3   F0           MOVX    @DPTR,A
   \   0000B4   A3           INC     DPTR
   \   0000B5   F0           MOVX    @DPTR,A
    281          }
   \   0000B6   741D         MOV     A,#0x1d
   \   0000B8   12....       LCALL   ?DEALLOC_XSTACK8
   \   0000BB                REQUIRE ?Subroutine0
   \   0000BB                ; // Fall through to label ?Subroutine0

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine0:
   \   000000   7F01         MOV     R7,#0x1
   \   000002   02....       LJMP    ?BANKED_LEAVE_XDATA
    282          
    283          /*********************************************************************
    284           * @fn      SerialApp_ProcessEvent
    285           *
    286           * @brief   Generic Application Task event processor.
    287           *
    288           * @param   task_id  - The OSAL assigned task ID.
    289           * @param   events   - Bit map of events to process.
    290           *
    291           * @return  Event flags of all unprocessed events.
    292           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    293          UINT16 SerialApp_ProcessEvent( uint8 task_id, UINT16 events )
   \                     SerialApp_ProcessEvent:
    294          {
   \   000000   74F4         MOV     A,#-0xc
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 12
   \   000005                ; Auto size: 0
   \   000005   EA           MOV     A,R2
   \   000006   FE           MOV     R6,A
   \   000007   EB           MOV     A,R3
   \   000008   FF           MOV     R7,A
    295            (void)task_id;  // Intentionally unreferenced parameter
    296            
    297            if ( events & SYS_EVENT_MSG )
   \   000009   5480         ANL     A,#0x80
   \   00000B   7033         JNZ     ??SerialApp_ProcessEvent_0
    298            {
    299              afIncomingMSGPacket_t *MSGpkt;
    300          
    301              while ( (MSGpkt = (afIncomingMSGPacket_t *)osal_msg_receive( SerialApp_TaskID )) )
    302              {
    303                switch ( MSGpkt->hdr.event )
    304                {
    305                case AF_INCOMING_MSG_CMD:
    306                  SerialApp_ProcessMSGCmd( MSGpkt );
    307                  break;
    308                  
    309                case ZDO_STATE_CHANGE:
    310                  SampleApp_NwkState = (devStates_t)(MSGpkt->hdr.status);
    311                  if ( (SampleApp_NwkState == DEV_ZB_COORD)
    312                      || (SampleApp_NwkState == DEV_ROUTER)
    313                      || (SampleApp_NwkState == DEV_END_DEVICE) )
    314                  {
    315                      // Start sending the periodic message in a regular interval.
    316                      HalLedSet(HAL_LED_1, HAL_LED_MODE_ON);
    317                      
    318                      if(SampleApp_NwkState != DEV_ZB_COORD)
    319                        SerialApp_DeviceConnect();              
    320                  }
    321                  else
    322                  {
    323                    // Device is no longer in the network
    324                  }
    325                  break;
    326          
    327                default:
    328                  break;
    329                }
    330          
    331                osal_msg_deallocate( (uint8 *)MSGpkt );
    332              }
    333          
    334              return ( events ^ SYS_EVENT_MSG );
    335            }
    336          
    337            if ( events & SERIALAPP_SEND_EVT )
   \   00000D   EE           MOV     A,R6
   \   00000E   A2E0         MOV     C,0xE0 /* A   */.0
   \   000010   505A         JNC     ??SerialApp_ProcessEvent_1
    338            {
    339              SerialApp_Send();
   \   000012                ; Setup parameters for call to function SerialApp_Send
   \   000012   12....       LCALL   ??SerialApp_Send?relay
    340              return ( events ^ SERIALAPP_SEND_EVT );
   \   000015   EE           MOV     A,R6
   \   000016   6401         XRL     A,#0x1
   \                     ??SerialApp_ProcessEvent_2:
   \   000018   FA           MOV     R2,A
   \   000019   EF           MOV     A,R7
   \                     ??SerialApp_ProcessEvent_3:
   \   00001A   FB           MOV     R3,A
   \   00001B   02....       LJMP    ??SerialApp_ProcessEvent_4 & 0xFFFF
    341            }
   \                     ??SerialApp_ProcessEvent_5:
   \   00001E   A3           INC     DPTR
   \   00001F   E0           MOVX    A,@DPTR
   \   000020   90....       MOV     DPTR,#SampleApp_NwkState
   \   000023   F0           MOVX    @DPTR,A
   \   000024   6409         XRL     A,#0x9
   \   000026   600A         JZ      ??SerialApp_ProcessEvent_6
   \   000028   E0           MOVX    A,@DPTR
   \   000029   6407         XRL     A,#0x7
   \   00002B   6005         JZ      ??SerialApp_ProcessEvent_6
   \   00002D   E0           MOVX    A,@DPTR
   \   00002E   6406         XRL     A,#0x6
   \   000030   7007         JNZ     ??SerialApp_ProcessEvent_7
   \                     ??SerialApp_ProcessEvent_6:
   \   000032                ; Setup parameters for call to function HalLedSet
   \   000032   7A01         MOV     R2,#0x1
   \   000034   7901         MOV     R1,#0x1
   \   000036   12....       LCALL   ??HalLedSet?relay
   \                     ??SerialApp_ProcessEvent_7:
   \   000039                ; Setup parameters for call to function osal_msg_deallocate
   \   000039   AA..         MOV     R2,?V0 + 0
   \   00003B   AB..         MOV     R3,?V0 + 1
   \   00003D   12....       LCALL   ??osal_msg_deallocate?relay
   \                     ??SerialApp_ProcessEvent_0:
   \   000040                ; Setup parameters for call to function osal_msg_receive
   \   000040   90....       MOV     DPTR,#SerialApp_TaskID
   \   000043   E0           MOVX    A,@DPTR
   \   000044   F9           MOV     R1,A
   \   000045   12....       LCALL   ??osal_msg_receive?relay
   \   000048   8A..         MOV     ?V0 + 0,R2
   \   00004A   8B..         MOV     ?V0 + 1,R3
   \   00004C   EA           MOV     A,R2
   \   00004D   45..         ORL     A,?V0 + 1
   \   00004F   6014         JZ      ??SerialApp_ProcessEvent_8
   \   000051   8A82         MOV     DPL,R2
   \   000053   8B83         MOV     DPH,R3
   \   000055   E0           MOVX    A,@DPTR
   \   000056   24E6         ADD     A,#-0x1a
   \   000058   6006         JZ      ??SerialApp_ProcessEvent_9
   \   00005A   2449         ADD     A,#0x49
   \   00005C   60C0         JZ      ??SerialApp_ProcessEvent_5
   \   00005E   80D9         SJMP    ??SerialApp_ProcessEvent_7
   \                     ??SerialApp_ProcessEvent_9:
   \   000060                ; Setup parameters for call to function SerialApp_ProcessMSGCmd
   \   000060   12....       LCALL   ??SerialApp_ProcessMSGCmd?relay
   \   000063   80D4         SJMP    ??SerialApp_ProcessEvent_7
   \                     ??SerialApp_ProcessEvent_8:
   \   000065   EE           MOV     A,R6
   \   000066   FA           MOV     R2,A
   \   000067   EF           MOV     A,R7
   \   000068   6480         XRL     A,#0x80
   \   00006A   80AE         SJMP    ??SerialApp_ProcessEvent_3
    342          
    343            if ( events & SERIALAPP_RESP_EVT )
   \                     ??SerialApp_ProcessEvent_1:
   \   00006C   5402         ANL     A,#0x2
   \   00006E   6051         JZ      ??SerialApp_ProcessEvent_10
    344            {
    345              SerialApp_Resp();
   \   000070                ; Setup parameters for call to function AF_DataRequest
   \   000070   75..1E       MOV     ?V0 + 0,#0x1e
   \   000073   78..         MOV     R0,#?V0 + 0
   \   000075   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   000078   75....       MOV     ?V0 + 0,#SerialApp_MsgID & 0xff
   \   00007B   75....       MOV     ?V0 + 1,#(SerialApp_MsgID >> 8) & 0xff
   \   00007E   78..         MOV     R0,#?V0 + 0
   \   000080   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000083   75....       MOV     ?V0 + 0,#SerialApp_RspBuf & 0xff
   \   000086   75....       MOV     ?V0 + 1,#(SerialApp_RspBuf >> 8) & 0xff
   \   000089   78..         MOV     R0,#?V0 + 0
   \   00008B   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   00008E   75..04       MOV     ?V0 + 0,#0x4
   \   000091   75..00       MOV     ?V0 + 1,#0x0
   \   000094   78..         MOV     R0,#?V0 + 0
   \   000096   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000099   75..02       MOV     ?V0 + 0,#0x2
   \   00009C   78..         MOV     R0,#?V0 + 0
   \   00009E   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   0000A1   7900         MOV     R1,#0x0
   \   0000A3   7C..         MOV     R4,#SerialApp_epDesc & 0xff
   \   0000A5   7D..         MOV     R5,#(SerialApp_epDesc >> 8) & 0xff
   \   0000A7   7A..         MOV     R2,#SerialApp_RxAddr & 0xff
   \   0000A9   7B..         MOV     R3,#(SerialApp_RxAddr >> 8) & 0xff
   \   0000AB   12....       LCALL   ??AF_DataRequest?relay
   \   0000AE   7409         MOV     A,#0x9
   \   0000B0   12....       LCALL   ?DEALLOC_XSTACK8
   \   0000B3   E9           MOV     A,R1
   \   0000B4   6005         JZ      ??CrossCallReturnLabel_4
   \   0000B6                ; Setup parameters for call to function osal_set_event
   \   0000B6   7A02         MOV     R2,#0x2
   \   0000B8   12....       LCALL   ?Subroutine4 & 0xFFFF
    346              return ( events ^ SERIALAPP_RESP_EVT );
   \                     ??CrossCallReturnLabel_4:
   \   0000BB   EE           MOV     A,R6
   \   0000BC   6402         XRL     A,#0x2
   \   0000BE   02....       LJMP    ??SerialApp_ProcessEvent_2 & 0xFFFF
    347            }
    348            if (events & SEND_UART){
   \                     ??SerialApp_ProcessEvent_10:
   \   0000C1   EE           MOV     A,R6
   \   0000C2   5404         ANL     A,#0x4
   \   0000C4   603D         JZ      ??SerialApp_ProcessEvent_11
    349              send_uart();
   \   0000C6   90....       MOV     DPTR,#cB + 411
   \   0000C9   E0           MOVX    A,@DPTR
   \   0000CA   6033         JZ      ??SerialApp_ProcessEvent_12
   \   0000CC   A3           INC     DPTR
   \   0000CD   12....       LCALL   ?Subroutine2 & 0xFFFF
   \                     ??CrossCallReturnLabel_0:
   \   0000D0   E0           MOVX    A,@DPTR
   \   0000D1   F5..         MOV     ?V0 + 0,A
   \   0000D3   E8           MOV     A,R0
   \   0000D4   75F028       MOV     B,#0x28
   \   0000D7   A4           MUL     AB
   \   0000D8   F8           MOV     R0,A
   \   0000D9   A9F0         MOV     R1,B
   \   0000DB   74..         MOV     A,#cB & 0xff
   \   0000DD   28           ADD     A,R0
   \   0000DE   FA           MOV     R2,A
   \   0000DF   74..         MOV     A,#(cB >> 8) & 0xff
   \   0000E1   39           ADDC    A,R1
   \   0000E2   FB           MOV     R3,A
   \   0000E3   90....       MOV     DPTR,#cB + 412
   \   0000E6   12....       LCALL   ?Subroutine3 & 0xFFFF
   \                     ??CrossCallReturnLabel_2:
   \   0000E9   7005         JNZ     ??SerialApp_ProcessEvent_13
   \   0000EB   90....       MOV     DPTR,#cB + 412
   \   0000EE   E4           CLR     A
   \   0000EF   F0           MOVX    @DPTR,A
   \                     ??SerialApp_ProcessEvent_13:
   \   0000F0   90....       MOV     DPTR,#cB + 411
   \   0000F3   E0           MOVX    A,@DPTR
   \   0000F4   14           DEC     A
   \   0000F5   F0           MOVX    @DPTR,A
   \   0000F6                ; Setup parameters for call to function HalUARTWrite
   \   0000F6   AC..         MOV     R4,?V0 + 0
   \   0000F8   7D00         MOV     R5,#0x0
   \   0000FA   7900         MOV     R1,#0x0
   \   0000FC   12....       LCALL   ??HalUARTWrite?relay
    350              return ( events );
   \                     ??SerialApp_ProcessEvent_12:
   \   0000FF   EE           MOV     A,R6
   \   000100   02....       LJMP    ??SerialApp_ProcessEvent_2 & 0xFFFF
    351            }
    352            return ( 0 );  // Discard unknown events.
   \                     ??SerialApp_ProcessEvent_11:
   \   000103   7A00         MOV     R2,#0x0
   \   000105   7B00         MOV     R3,#0x0
   \                     ??SerialApp_ProcessEvent_4:
   \   000107                REQUIRE ?Subroutine1
   \   000107                ; // Fall through to label ?Subroutine1
    353          }

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine1:
   \   000000   7F04         MOV     R7,#0x4
   \   000002   02....       LJMP    ?BANKED_LEAVE_XDATA
    354          
    355          /*********************************************************************
    356           * @fn      SerialApp_ProcessMSGCmd
    357           *
    358           * @brief   Data message processor callback. This function processes
    359           *          any incoming data - probably from other devices. Based
    360           *          on the cluster ID, perform the intended action.
    361           *
    362           * @param   pkt - pointer to the incoming message packet
    363           *
    364           * @return  TRUE if the 'pkt' parameter is being used and will be freed later,
    365           *          FALSE otherwise.
    366           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    367          void SerialApp_ProcessMSGCmd( afIncomingMSGPacket_t *pkt )
   \                     SerialApp_ProcessMSGCmd:
    368          {
   \   000000   74F2         MOV     A,#-0xe
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 14
   \   000005                ; Auto size: 0
   \   000005   EA           MOV     A,R2
   \   000006   FE           MOV     R6,A
   \   000007   EB           MOV     A,R3
   \   000008   FF           MOV     R7,A
    369            char buf[30]={0};
                        ^
Warning[Pe177]: variable "buf" was declared but never referenced
    370            uint8 stat;
                         ^
Warning[Pe177]: variable "stat" was declared but never referenced
    371            uint8 seqnb;
                         ^
Warning[Pe550]: variable "seqnb" was set but never used

  static uint8 SerialApp_RxSeq;
               ^
"E:\CollegeCourse\ThDSemester-2\EmbeddedSystem\ZigBee\ZStack-final\Projects\zstack\Utilities\SerialApp\Source\SerialApp.c",138  Warning[Pe550]: 
          variable "SerialApp_RxSeq" was set but never used
    372            uint8 delay;
    373          
    374            switch ( pkt->clusterId )
   \   000009   EE           MOV     A,R6
   \   00000A   2421         ADD     A,#0x21
   \   00000C   F5..         MOV     ?V0 + 4,A
   \   00000E   EF           MOV     A,R7
   \   00000F   3400         ADDC    A,#0x0
   \   000011   F5..         MOV     ?V0 + 5,A
   \   000013   8E82         MOV     DPL,R6
   \   000015   8F83         MOV     DPH,R7
   \   000017   A3           INC     DPTR
   \   000018   A3           INC     DPTR
   \   000019   A3           INC     DPTR
   \   00001A   A3           INC     DPTR
   \   00001B   E0           MOVX    A,@DPTR
   \   00001C   F5..         MOV     ?V0 + 0,A
   \   00001E   A3           INC     DPTR
   \   00001F   E0           MOVX    A,@DPTR
   \   000020   F5..         MOV     ?V0 + 1,A
   \   000022   78..         MOV     R0,#?V0 + 0
   \   000024   12....       LCALL   ?US_SWITCH_DENSE
   \                     `?<Jumptable for SerialApp_ProcessMSGCmd>_0`:
   \   000027   0100         DW        1
   \   000029   02           DB        2
   \   00002A   ....         DW        ??SerialApp_ProcessMSGCmd_0
   \   00002C   ....         DW        ??SerialApp_ProcessMSGCmd_1
   \   00002E   ....         DW        ??SerialApp_ProcessMSGCmd_2
   \   000030   ....         DW        ??SerialApp_ProcessMSGCmd_3
    375            {
    376            // A message with a serial data block to be transmitted on the serial port.
    377            case SERIALAPP_CLUSTERID1: //收到发送过来的数据通过串口输出到电脑显示
    378              // Store the address for sending and retrying.
    379              osal_memcpy(&SerialApp_RxAddr, &(pkt->srcAddr), sizeof( afAddrType_t ));
   \                     ??SerialApp_ProcessMSGCmd_1:
   \   000032                ; Setup parameters for call to function osal_memcpy
   \   000032   EE           MOV     A,R6
   \   000033   2406         ADD     A,#0x6
   \   000035   F5..         MOV     ?V0 + 0,A
   \   000037   EF           MOV     A,R7
   \   000038   3400         ADDC    A,#0x0
   \   00003A   F5..         MOV     ?V0 + 1,A
   \   00003C   75..00       MOV     ?V0 + 2,#0x0
   \   00003F   78..         MOV     R0,#?V0 + 0
   \   000041   12....       LCALL   ?PUSH_XSTACK_I_THREE
   \   000044   7C0C         MOV     R4,#0xc
   \   000046   7D00         MOV     R5,#0x0
   \   000048   7A..         MOV     R2,#SerialApp_RxAddr & 0xff
   \   00004A   7B..         MOV     R3,#(SerialApp_RxAddr >> 8) & 0xff
   \   00004C   12....       LCALL   ??osal_memcpy?relay
   \   00004F   7403         MOV     A,#0x3
   \   000051   12....       LCALL   ?DEALLOC_XSTACK8
    380          
    381              seqnb = pkt->cmd.Data[0];
    382              //sprintf(buf,"segnb= %d\n",seqnb);
    383              //HalUARTWrite( SERIAL_APP_PORT, (uint8*)buf, strlen(buf));
    384              // Keep message if not a repeat packet
    385              pushElement(pkt->cmd.Data+1, (pkt->cmd.DataLength-1));
   \   000054   EE           MOV     A,R6
   \   000055   241F         ADD     A,#0x1f
   \   000057   F582         MOV     DPL,A
   \   000059   EF           MOV     A,R7
   \   00005A   3400         ADDC    A,#0x0
   \   00005C   F583         MOV     DPH,A
   \   00005E   E0           MOVX    A,@DPTR
   \   00005F   14           DEC     A
   \   000060   FE           MOV     R6,A
   \   000061   90....       MOV     DPTR,#cB + 411
   \   000064   E0           MOVX    A,@DPTR
   \   000065   F8           MOV     R0,A
   \   000066   90....       MOV     DPTR,#cB + 410
   \   000069   E0           MOVX    A,@DPTR
   \   00006A   68           XRL     A,R0
   \   00006B   7003         JNZ     $+5
   \   00006D   02....       LJMP    ??SerialApp_ProcessMSGCmd_0 & 0xFFFF
   \   000070                ; Setup parameters for call to function osal_memcpy
   \   000070   85..82       MOV     DPL,?V0 + 4
   \   000073   85..83       MOV     DPH,?V0 + 5
   \   000076   E0           MOVX    A,@DPTR
   \   000077   2401         ADD     A,#0x1
   \   000079   F5..         MOV     ?V0 + 0,A
   \   00007B   A3           INC     DPTR
   \   00007C   E0           MOVX    A,@DPTR
   \   00007D   3400         ADDC    A,#0x0
   \   00007F   F5..         MOV     ?V0 + 1,A
   \   000081   78..         MOV     R0,#?V0 + 0
   \   000083   12....       LCALL   ?PUSH_XSTACK_I_THREE
   \   000086   8E..         MOV     ?V0 + 0,R6
   \   000088   AC..         MOV     R4,?V0 + 0
   \   00008A   7D00         MOV     R5,#0x0
   \   00008C   90....       MOV     DPTR,#cB + 413
   \   00008F   E0           MOVX    A,@DPTR
   \   000090   75F028       MOV     B,#0x28
   \   000093   A4           MUL     AB
   \   000094   F8           MOV     R0,A
   \   000095   A9F0         MOV     R1,B
   \   000097   74..         MOV     A,#cB & 0xff
   \   000099   28           ADD     A,R0
   \   00009A   FA           MOV     R2,A
   \   00009B   74..         MOV     A,#(cB >> 8) & 0xff
   \   00009D   39           ADDC    A,R1
   \   00009E   FB           MOV     R3,A
   \   00009F   12....       LCALL   ??osal_memcpy?relay
   \   0000A2   7403         MOV     A,#0x3
   \   0000A4   12....       LCALL   ?DEALLOC_XSTACK8
   \   0000A7   90....       MOV     DPTR,#cB + 413
   \   0000AA   12....       LCALL   ?Subroutine2 & 0xFFFF
   \                     ??CrossCallReturnLabel_1:
   \   0000AD   EE           MOV     A,R6
   \   0000AE   F0           MOVX    @DPTR,A
   \   0000AF   90....       MOV     DPTR,#cB + 413
   \   0000B2   12....       LCALL   ?Subroutine3 & 0xFFFF
   \                     ??CrossCallReturnLabel_3:
   \   0000B5   7005         JNZ     ??SerialApp_ProcessMSGCmd_4
   \   0000B7   90....       MOV     DPTR,#cB + 413
   \   0000BA   E4           CLR     A
   \   0000BB   F0           MOVX    @DPTR,A
   \                     ??SerialApp_ProcessMSGCmd_4:
   \   0000BC   90....       MOV     DPTR,#cB + 411
   \   0000BF   E0           MOVX    A,@DPTR
   \   0000C0   04           INC     A
   \   0000C1   F0           MOVX    @DPTR,A
   \   0000C2                ; Setup parameters for call to function osal_set_event
   \   0000C2   7A04         MOV     R2,#0x4
   \   0000C4   12....       LCALL   ?Subroutine4 & 0xFFFF
   \                     ??CrossCallReturnLabel_6:
   \   0000C7   806F         SJMP    ??SerialApp_ProcessMSGCmd_0
    386              //SerialApp_RxSeq = seqnb;
    387              //stat = OTA_SUCCESS;
    388              // Select approproiate OTA flow-control delay.
    389              //delay = (stat == OTA_SER_BUSY) ? SERIALAPP_NAK_DELAY : SERIALAPP_ACK_DELAY;
    390          
    391              // Build & send OTA response message.
    392              //SerialApp_RspBuf[0] = stat;
    393              //SerialApp_RspBuf[1] = seqnb;
    394              //SerialApp_RspBuf[2] = LO_UINT16( delay );
    395              //SerialApp_RspBuf[3] = HI_UINT16( delay );
    396              //SerialApp_Resp();
    397              //osal_set_event( SerialApp_TaskID, SERIALAPP_RESP_EVT ); //收到数据后，发送一个响应事件
    398              //osal_stop_timerEx(SerialApp_TaskID, SERIALAPP_RESP_EVT);
    399              break;
    400          
    401            // A response to a received serial data block.   // 接到响应消息
    402            case SERIALAPP_CLUSTERID2:
    403              if ((pkt->cmd.Data[1] == SerialApp_TxSeq) &&
    404                 ((pkt->cmd.Data[0] == OTA_SUCCESS) || (pkt->cmd.Data[0] == OTA_DUP_MSG)))
   \                     ??SerialApp_ProcessMSGCmd_2:
   \   0000C9   85..82       MOV     DPL,?V0 + 4
   \   0000CC   85..83       MOV     DPH,?V0 + 5
   \   0000CF   E0           MOVX    A,@DPTR
   \   0000D0   F8           MOV     R0,A
   \   0000D1   A3           INC     DPTR
   \   0000D2   E0           MOVX    A,@DPTR
   \   0000D3   F9           MOV     R1,A
   \   0000D4   8882         MOV     DPL,R0
   \   0000D6   8983         MOV     DPH,R1
   \   0000D8   A3           INC     DPTR
   \   0000D9   E0           MOVX    A,@DPTR
   \   0000DA   FA           MOV     R2,A
   \   0000DB   90....       MOV     DPTR,#SerialApp_TxSeq
   \   0000DE   E0           MOVX    A,@DPTR
   \   0000DF   6A           XRL     A,R2
   \   0000E0   701D         JNZ     ??SerialApp_ProcessMSGCmd_5
   \   0000E2   8882         MOV     DPL,R0
   \   0000E4   8983         MOV     DPH,R1
   \   0000E6   E0           MOVX    A,@DPTR
   \   0000E7   6004         JZ      ??SerialApp_ProcessMSGCmd_6
   \   0000E9   6401         XRL     A,#0x1
   \   0000EB   7012         JNZ     ??SerialApp_ProcessMSGCmd_5
    405              {
    406                SerialApp_TxLen = 0;
   \                     ??SerialApp_ProcessMSGCmd_6:
   \   0000ED   90....       MOV     DPTR,#SerialApp_TxLen
   \   0000F0   E4           CLR     A
   \   0000F1   F0           MOVX    @DPTR,A
    407                osal_stop_timerEx(SerialApp_TaskID, SERIALAPP_SEND_EVT);
   \   0000F2                ; Setup parameters for call to function osal_stop_timerEx
   \   0000F2   7A01         MOV     R2,#0x1
   \   0000F4   FB           MOV     R3,A
   \   0000F5   90....       MOV     DPTR,#SerialApp_TaskID
   \   0000F8   E0           MOVX    A,@DPTR
   \   0000F9   F9           MOV     R1,A
   \   0000FA   12....       LCALL   ??osal_stop_timerEx?relay
   \   0000FD   8016         SJMP    ??SerialApp_ProcessMSGCmd_7
    408              }
    409              else
    410              {
    411                // Re-start timeout according to delay sent from other device.
    412                delay = BUILD_UINT16( pkt->cmd.Data[2], pkt->cmd.Data[3] );
    413                osal_start_timerEx( SerialApp_TaskID, SERIALAPP_SEND_EVT, delay );
   \                     ??SerialApp_ProcessMSGCmd_5:
   \   0000FF                ; Setup parameters for call to function osal_start_timerEx
   \   0000FF   8882         MOV     DPL,R0
   \   000101   8983         MOV     DPH,R1
   \   000103   A3           INC     DPTR
   \   000104   A3           INC     DPTR
   \   000105   E0           MOVX    A,@DPTR
   \   000106   FC           MOV     R4,A
   \   000107   7D00         MOV     R5,#0x0
   \   000109   7A01         MOV     R2,#0x1
   \   00010B   7B00         MOV     R3,#0x0
   \   00010D   90....       MOV     DPTR,#SerialApp_TaskID
   \   000110   E0           MOVX    A,@DPTR
   \   000111   F9           MOV     R1,A
   \   000112   12....       LCALL   ??osal_start_timerEx?relay
    414              }
    415              HalLedSet(HAL_LED_2, HAL_LED_MODE_ON);
   \                     ??SerialApp_ProcessMSGCmd_7:
   \   000115                ; Setup parameters for call to function HalLedSet
   \   000115   7A01         MOV     R2,#0x1
   \   000117   7902         MOV     R1,#0x2
   \   000119   12....       LCALL   ??HalLedSet?relay
    416              break;
   \   00011C   801A         SJMP    ??SerialApp_ProcessMSGCmd_0
    417          
    418              case SERIALAPP_CONNECTREQ_CLUSTER:
    419                SerialApp_ConnectReqProcess((uint8*)pkt->cmd.Data, pkt->srcAddr.endPoint);
   \                     ??SerialApp_ProcessMSGCmd_3:
   \   00011E                ; Setup parameters for call to function SerialApp_ConnectReqProcess
   \   00011E   EE           MOV     A,R6
   \   00011F   240F         ADD     A,#0xf
   \   000121   F582         MOV     DPL,A
   \   000123   EF           MOV     A,R7
   \   000124   3400         ADDC    A,#0x0
   \   000126   F583         MOV     DPH,A
   \   000128   E0           MOVX    A,@DPTR
   \   000129   F9           MOV     R1,A
   \   00012A   85..82       MOV     DPL,?V0 + 4
   \   00012D   85..83       MOV     DPH,?V0 + 5
   \   000130   E0           MOVX    A,@DPTR
   \   000131   FA           MOV     R2,A
   \   000132   A3           INC     DPTR
   \   000133   E0           MOVX    A,@DPTR
   \   000134   FB           MOV     R3,A
   \   000135   12....       LCALL   ??SerialApp_ConnectReqProcess?relay
    420                
    421              case SERIALAPP_CONNECTRSP_CLUSTER:
    422                SerialApp_DeviceConnectRsp((uint8*)pkt->cmd.Data);
    423                
    424              default:
    425                break;
    426            }
    427          }
   \                     ??SerialApp_ProcessMSGCmd_0:
   \   000138   7F06         MOV     R7,#0x6
   \   00013A   02....       LJMP    ?BANKED_LEAVE_XDATA

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine4:
   \   000000   7B00         MOV     R3,#0x0
   \   000002   90....       MOV     DPTR,#SerialApp_TaskID
   \   000005   E0           MOVX    A,@DPTR
   \   000006   F9           MOV     R1,A
   \   000007   12....       LCALL   ??osal_set_event?relay
   \   00000A   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine3:
   \   000000   E0           MOVX    A,@DPTR
   \   000001   04           INC     A
   \   000002   F0           MOVX    @DPTR,A
   \   000003   F8           MOV     R0,A
   \   000004   90....       MOV     DPTR,#cB + 410
   \   000007   E0           MOVX    A,@DPTR
   \   000008   68           XRL     A,R0
   \   000009   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine2:
   \   000000   E0           MOVX    A,@DPTR
   \   000001   F8           MOV     R0,A
   \   000002   74..         MOV     A,#(cB + 144) & 0xff
   \   000004   28           ADD     A,R0
   \   000005   F582         MOV     DPL,A
   \   000007   74..         MOV     A,#((cB + 400) >> 8) & 0xff
   \   000009   3400         ADDC    A,#0x0
   \   00000B   F583         MOV     DPH,A
   \   00000D   22           RET
    428          
    429          /*********************************************************************
    430           * @fn      SerialApp_Send
    431           *
    432           * @brief   Send data OTA.
    433           *
    434           * @param   none
    435           *
    436           * @return  none
    437           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    438          static void SerialApp_Send(void)
   \                     SerialApp_Send:
    439          {
   \   000000   74F6         MOV     A,#-0xa
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 10
   \   000005                ; Auto size: 0
    440          #if SERIAL_APP_LOOPBACK
    441              if (SerialApp_TxLen < SERIAL_APP_TX_MAX)
    442              {
    443                  SerialApp_TxLen += HalUARTRead(SERIAL_APP_PORT, SerialApp_TxBuf+SerialApp_TxLen+1,
    444                                                                SERIAL_APP_TX_MAX-SerialApp_TxLen);
    445              }
    446            
    447              if (SerialApp_TxLen)
    448              {
    449                (void)SerialApp_TxAddr;
    450                if (HalUARTWrite(SERIAL_APP_PORT, SerialApp_TxBuf+1, SerialApp_TxLen))
    451                {
    452                  SerialApp_TxLen = 0;
    453                }
    454                else
    455                {
    456                  osal_set_event(SerialApp_TaskID, SERIALAPP_SEND_EVT);
    457                }
    458              }
    459          #else
    460              if (SerialApp_TxLen = HalUARTRead(SERIAL_APP_PORT, SerialApp_TxBuf+1, SERIAL_APP_TX_MAX))
   \   000005                ; Setup parameters for call to function HalUARTRead
   \   000005   7C50         MOV     R4,#0x50
   \   000007   7D00         MOV     R5,#0x0
   \   000009   7A..         MOV     R2,#(SerialApp_TxBuf + 1) & 0xff
   \   00000B   7B..         MOV     R3,#((SerialApp_TxBuf + 1) >> 8) & 0xff
   \   00000D   7900         MOV     R1,#0x0
   \   00000F   12....       LCALL   ??HalUARTRead?relay
   \   000012   EA           MOV     A,R2
   \   000013   90....       MOV     DPTR,#SerialApp_TxLen
   \   000016   F0           MOVX    @DPTR,A
   \   000017   605F         JZ      ??CrossCallReturnLabel_5
    461              {
    462                // Pre-pend sequence number to the Tx message.
    463                SerialApp_TxBuf[0] = ++SerialApp_TxSeq;
   \   000019   90....       MOV     DPTR,#SerialApp_TxSeq
   \   00001C   E0           MOVX    A,@DPTR
   \   00001D   04           INC     A
   \   00001E   F0           MOVX    @DPTR,A
   \   00001F   90....       MOV     DPTR,#SerialApp_TxBuf
   \   000022   F0           MOVX    @DPTR,A
    464              }
    465              if (SerialApp_TxLen)
    466              {
    467                if (afStatus_SUCCESS != AF_DataRequest(&SerialApp_TxAddr,
    468                                                       (endPointDesc_t *)&SerialApp_epDesc,
    469                                                        SERIALAPP_CLUSTERID1,
    470                                                        SerialApp_TxLen+1, SerialApp_TxBuf,
    471                                                        &SerialApp_MsgID, 0, AF_DEFAULT_RADIUS))
   \   000023                ; Setup parameters for call to function AF_DataRequest
   \   000023   75..1E       MOV     ?V0 + 0,#0x1e
   \   000026   78..         MOV     R0,#?V0 + 0
   \   000028   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   00002B   75....       MOV     ?V0 + 0,#SerialApp_MsgID & 0xff
   \   00002E   75....       MOV     ?V0 + 1,#(SerialApp_MsgID >> 8) & 0xff
   \   000031   78..         MOV     R0,#?V0 + 0
   \   000033   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000036   75....       MOV     ?V0 + 0,#SerialApp_TxBuf & 0xff
   \   000039   75....       MOV     ?V0 + 1,#(SerialApp_TxBuf >> 8) & 0xff
   \   00003C   78..         MOV     R0,#?V0 + 0
   \   00003E   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000041   90....       MOV     DPTR,#SerialApp_TxLen
   \   000044   E0           MOVX    A,@DPTR
   \   000045   2401         ADD     A,#0x1
   \   000047   F5..         MOV     ?V0 + 0,A
   \   000049   E4           CLR     A
   \   00004A   3400         ADDC    A,#0x0
   \   00004C   F5..         MOV     ?V0 + 1,A
   \   00004E   78..         MOV     R0,#?V0 + 0
   \   000050   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000053   75..01       MOV     ?V0 + 0,#0x1
   \   000056   75..00       MOV     ?V0 + 1,#0x0
   \   000059   78..         MOV     R0,#?V0 + 0
   \   00005B   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   00005E   7900         MOV     R1,#0x0
   \   000060   7C..         MOV     R4,#SerialApp_epDesc & 0xff
   \   000062   7D..         MOV     R5,#(SerialApp_epDesc >> 8) & 0xff
   \   000064   7A..         MOV     R2,#SerialApp_TxAddr & 0xff
   \   000066   7B..         MOV     R3,#(SerialApp_TxAddr >> 8) & 0xff
   \   000068   12....       LCALL   ??AF_DataRequest?relay
   \   00006B   7409         MOV     A,#0x9
   \   00006D   12....       LCALL   ?DEALLOC_XSTACK8
   \   000070   E9           MOV     A,R1
   \   000071   6005         JZ      ??CrossCallReturnLabel_5
    472                {
    473                  osal_set_event(SerialApp_TaskID, SERIALAPP_SEND_EVT);
   \   000073                ; Setup parameters for call to function osal_set_event
   \   000073   7A01         MOV     R2,#0x1
   \   000075   12....       LCALL   ?Subroutine4 & 0xFFFF
    474                }
    475              }
    476              HalLedSet(HAL_LED_2, HAL_LED_MODE_OFF);
   \                     ??CrossCallReturnLabel_5:
   \   000078                ; Setup parameters for call to function HalLedSet
   \   000078   7A00         MOV     R2,#0x0
   \   00007A   7902         MOV     R1,#0x2
   \   00007C   12....       LCALL   ??HalLedSet?relay
    477          #endif
    478          }
   \   00007F   7F02         MOV     R7,#0x2
   \   000081   02....       LJMP    ?BANKED_LEAVE_XDATA
    479          
    480          /*********************************************************************
    481           * @fn      SerialApp_Resp
    482           *
    483           * @brief   Send data OTA.
    484           *
    485           * @param   none
    486           *
    487           * @return  none
    488           */
    489          static void SerialApp_Resp(void)
    490          {
    491            if (afStatus_SUCCESS != AF_DataRequest(&SerialApp_RxAddr,
    492                                                   (endPointDesc_t *)&SerialApp_epDesc,
    493                                                    SERIALAPP_CLUSTERID2,
    494                                                    SERIAL_APP_RSP_CNT, SerialApp_RspBuf,
    495                                                   &SerialApp_MsgID, 0, AF_DEFAULT_RADIUS))
    496            {
    497              osal_set_event(SerialApp_TaskID, SERIALAPP_RESP_EVT);
    498            }
    499          }
    500          
    501          /*********************************************************************
    502           * @fn      SerialApp_CallBack
    503           *
    504           * @brief   Send data OTA.
    505           *
    506           * @param   port - UART port.
    507           * @param   event - the UART port event flag.
    508           *
    509           * @return  none
    510           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    511          static void SerialApp_CallBack(uint8 port, uint8 event)
   \                     SerialApp_CallBack:
    512          {
   \   000000   74F7         MOV     A,#-0x9
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 0
   \   000005   EA           MOV     A,R2
   \   000006   FE           MOV     R6,A
    513            (void)port;
    514          
    515            if ((event & (HAL_UART_RX_FULL | HAL_UART_RX_ABOUT_FULL | HAL_UART_RX_TIMEOUT)) &&
    516          #if SERIAL_APP_LOOPBACK
    517                (SerialApp_TxLen < SERIAL_APP_TX_MAX))
    518          #else
    519                1)
   \   000007   7407         MOV     A,#0x7
   \   000009   5E           ANL     A,R6
   \   00000A   6003         JZ      ??SerialApp_CallBack_0
    520          #endif
    521            {
    522              SerialApp_Send();
   \   00000C                ; Setup parameters for call to function SerialApp_Send
   \   00000C   12....       LCALL   ??SerialApp_Send?relay
    523            }
    524          }
   \                     ??SerialApp_CallBack_0:
   \   00000F   02....       LJMP    ?Subroutine0 & 0xFFFF
    525          
    526          /*********************************************************************
    527          *********************************************************************/
    528          void  SerialApp_DeviceConnect()              
    529          {
    530          #if ZDO_COORDINATOR
    531            
    532          #else
    533            
    534            uint16 nwkAddr;
    535            uint16 parentNwkAddr;
    536            char buff[30] = {0};
    537            
    538            HalLedBlink( HAL_LED_2, 3, 50, (1000 / 4) );
    539            
    540            nwkAddr = NLME_GetShortAddr();
    541            parentNwkAddr = NLME_GetCoordShortAddr();
    542            sprintf(buff, "p:%d   s:%d\r\n", parentNwkAddr, nwkAddr);
    543            HalUARTWrite ( 0, (uint8*)buff, strlen(buff));
    544            
    545            SerialApp_TxAddr.addrMode = (afAddrMode_t)Addr16Bit;
    546            SerialApp_TxAddr.endPoint = SERIALAPP_COORPOINT;
    547            SerialApp_TxAddr.addr.shortAddr = parentNwkAddr;
    548            
    549            buff[0] = HI_UINT16( nwkAddr );
    550            buff[1] = LO_UINT16( nwkAddr );
    551            
    552            if ( AF_DataRequest( &SerialApp_TxAddr, &SerialApp_epDesc,
    553                                 SERIALAPP_CONNECTREQ_CLUSTER,
    554                                 2,
    555                                 (uint8*)buff,
    556                                 &SerialApp_MsgID, 
    557                                 0, 
    558                                 AF_DEFAULT_RADIUS ) == afStatus_SUCCESS )
    559            {
    560            }
    561            else
    562            {
    563              // Error occurred in request to send.
    564            }
    565            
    566          #endif    //ZDO_COORDINATOR
    567          }
    568          
    569          void SerialApp_DeviceConnectRsp(uint8 *buf)
    570          {
    571          #if ZDO_COORDINATOR
    572            
    573          #else
    574            SerialApp_TxAddr.addrMode = (afAddrMode_t)Addr16Bit;
    575            SerialApp_TxAddr.endPoint = SERIALAPP_COORPOINT;
    576            SerialApp_TxAddr.addr.shortAddr = BUILD_UINT16(buf[1], buf[0]);
    577            
    578            HalLedSet(HAL_LED_2, HAL_LED_MODE_ON);
    579            HalUARTWrite ( 0, "connect success, endpoint\n", 23);
    580          #endif
    581          }
    582          

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    583          void SerialApp_ConnectReqProcess(uint8 *buf, uint8 endPoint)
   \                     SerialApp_ConnectReqProcess:
    584          {
   \   000000   74F4         MOV     A,#-0xc
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 12
   \   000005                ; Auto size: 30
   \   000005   74E2         MOV     A,#-0x1e
   \   000007   12....       LCALL   ?ALLOC_XSTACK8
   \   00000A   E9           MOV     A,R1
   \   00000B   FE           MOV     R6,A
    585            uint16 nwkAddr;
    586            char buff[30] = {0};
   \   00000C   85..82       MOV     DPL,?XSP + 0
   \   00000F   85..83       MOV     DPH,?XSP + 1
   \   000012   AC82         MOV     R4,DPL
   \   000014   AD83         MOV     R5,DPH
   \   000016   7583..       MOV     DPH,#(`?<Constant {0}>` >> 8) & 0xff
   \   000019   7582..       MOV     DPL,#`?<Constant {0}>` & 0xff
   \   00001C   741E         MOV     A,#0x1e
   \   00001E   12....       LCALL   ?MOVE_LONG8_XDATA_XDATA
    587            
    588            SerialApp_TxAddr.addrMode = (afAddrMode_t)Addr16Bit;
   \   000021   90....       MOV     DPTR,#SerialApp_TxAddr + 8
   \   000024   7402         MOV     A,#0x2
   \   000026   F0           MOVX    @DPTR,A
    589            SerialApp_TxAddr.endPoint = endPoint;
   \   000027   EE           MOV     A,R6
   \   000028   A3           INC     DPTR
   \   000029   F0           MOVX    @DPTR,A
    590            SerialApp_TxAddr.addr.shortAddr = BUILD_UINT16(buf[1], buf[0]);
   \   00002A   8A82         MOV     DPL,R2
   \   00002C   8B83         MOV     DPH,R3
   \   00002E   A3           INC     DPTR
   \   00002F   E0           MOVX    A,@DPTR
   \   000030   FC           MOV     R4,A
   \   000031   8A82         MOV     DPL,R2
   \   000033   8B83         MOV     DPH,R3
   \   000035   E0           MOVX    A,@DPTR
   \   000036   F9           MOV     R1,A
   \   000037   EC           MOV     A,R4
   \   000038   90....       MOV     DPTR,#SerialApp_TxAddr
   \   00003B   F0           MOVX    @DPTR,A
   \   00003C   A3           INC     DPTR
   \   00003D   E9           MOV     A,R1
   \   00003E   F0           MOVX    @DPTR,A
    591            nwkAddr = NLME_GetShortAddr();
   \   00003F                ; Setup parameters for call to function NLME_GetShortAddr
   \   00003F   12....       LCALL   ??NLME_GetShortAddr?relay
   \   000042   8A..         MOV     ?V0 + 0,R2
   \   000044   8B..         MOV     ?V0 + 1,R3
    592            
    593            sprintf(buff, "s:%d  c:%d  endpoint: %d\r\n", nwkAddr, SerialApp_TxAddr.addr.shortAddr, endPoint);
   \   000046                ; Setup parameters for call to function sprintf
   \   000046   8E..         MOV     ?V0 + 2,R6
   \   000048   75..00       MOV     ?V0 + 3,#0x0
   \   00004B   78..         MOV     R0,#?V0 + 2
   \   00004D   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000050   90....       MOV     DPTR,#SerialApp_TxAddr
   \   000053   12....       LCALL   ?PUSH_XSTACK8_X_TWO
   \   000056   78..         MOV     R0,#?V0 + 0
   \   000058   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   00005B   7C..         MOV     R4,#`?<Constant "s:%d  c:%d  endpoint:...">` & 0xff
   \   00005D   7D..         MOV     R5,#(`?<Constant "s:%d  c:%d  endpoint:...">` >> 8) & 0xff
   \   00005F   7406         MOV     A,#0x6
   \   000061   12....       LCALL   ?XSTACK_DISP0_8
   \   000064   AA82         MOV     R2,DPL
   \   000066   AB83         MOV     R3,DPH
   \   000068   12....       LCALL   ??sprintf?relay
   \   00006B   7406         MOV     A,#0x6
   \   00006D   12....       LCALL   ?DEALLOC_XSTACK8
    594            HalUARTWrite ( 0, (uint8*)buff, strlen(buff));
   \   000070                ; Setup parameters for call to function HalUARTWrite
   \   000070                ; Setup parameters for call to function strlen
   \   000070   85..82       MOV     DPL,?XSP + 0
   \   000073   85..83       MOV     DPH,?XSP + 1
   \   000076   AA82         MOV     R2,DPL
   \   000078   AB83         MOV     R3,DPH
   \   00007A   12....       LCALL   ??strlen?relay
   \   00007D   EA           MOV     A,R2
   \   00007E   FC           MOV     R4,A
   \   00007F   EB           MOV     A,R3
   \   000080   FD           MOV     R5,A
   \   000081   85..82       MOV     DPL,?XSP + 0
   \   000084   85..83       MOV     DPH,?XSP + 1
   \   000087   AA82         MOV     R2,DPL
   \   000089   AB83         MOV     R3,DPH
   \   00008B   7900         MOV     R1,#0x0
   \   00008D   12....       LCALL   ??HalUARTWrite?relay
    595            
    596            buff[0] = HI_UINT16( nwkAddr );
   \   000090   85..82       MOV     DPL,?XSP + 0
   \   000093   85..83       MOV     DPH,?XSP + 1
   \   000096   E5..         MOV     A,?V0 + 1
   \   000098   F0           MOVX    @DPTR,A
    597            buff[1] = LO_UINT16( nwkAddr );
   \   000099   7401         MOV     A,#0x1
   \   00009B   12....       LCALL   ?XSTACK_DISP0_8
   \   00009E   E5..         MOV     A,?V0 + 0
   \   0000A0   F0           MOVX    @DPTR,A
    598            
    599            if ( AF_DataRequest( &SerialApp_TxAddr, &SerialApp_epDesc,
    600                                 SERIALAPP_CONNECTRSP_CLUSTER,
    601                                 2,
    602                                 (uint8*)buff,
    603                                 &SerialApp_MsgID, 
    604                                 0, 
    605                                 AF_DEFAULT_RADIUS ) == afStatus_SUCCESS )
   \   0000A1                ; Setup parameters for call to function AF_DataRequest
   \   0000A1   75..1E       MOV     ?V0 + 0,#0x1e
   \   0000A4   78..         MOV     R0,#?V0 + 0
   \   0000A6   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   0000A9   75....       MOV     ?V0 + 0,#SerialApp_MsgID & 0xff
   \   0000AC   75....       MOV     ?V0 + 1,#(SerialApp_MsgID >> 8) & 0xff
   \   0000AF   78..         MOV     R0,#?V0 + 0
   \   0000B1   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   0000B4   7403         MOV     A,#0x3
   \   0000B6   12....       LCALL   ?XSTACK_DISP0_8
   \   0000B9   8582..       MOV     ?V0 + 0,DPL
   \   0000BC   8583..       MOV     ?V0 + 1,DPH
   \   0000BF   78..         MOV     R0,#?V0 + 0
   \   0000C1   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   0000C4   75..02       MOV     ?V0 + 0,#0x2
   \   0000C7   75..00       MOV     ?V0 + 1,#0x0
   \   0000CA   78..         MOV     R0,#?V0 + 0
   \   0000CC   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   0000CF   75..04       MOV     ?V0 + 0,#0x4
   \   0000D2   78..         MOV     R0,#?V0 + 0
   \   0000D4   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   0000D7   7900         MOV     R1,#0x0
   \   0000D9   7C..         MOV     R4,#SerialApp_epDesc & 0xff
   \   0000DB   7D..         MOV     R5,#(SerialApp_epDesc >> 8) & 0xff
   \   0000DD   7A..         MOV     R2,#SerialApp_TxAddr & 0xff
   \   0000DF   7B..         MOV     R3,#(SerialApp_TxAddr >> 8) & 0xff
   \   0000E1   12....       LCALL   ??AF_DataRequest?relay
   \   0000E4   7409         MOV     A,#0x9
   \   0000E6   12....       LCALL   ?DEALLOC_XSTACK8
    606            {
    607            }
    608            else
    609            {
    610              // Error occurred in request to send.
    611            }
    612            SerialApp_TxAddr.addrMode = afAddrBroadcast;
   \   0000E9   90....       MOV     DPTR,#SerialApp_TxAddr + 8
   \   0000EC   740F         MOV     A,#0xf
   \   0000EE   F0           MOVX    @DPTR,A
    613            SerialApp_TxAddr.addr.shortAddr = 0xFFFF;
   \   0000EF   90....       MOV     DPTR,#SerialApp_TxAddr
   \   0000F2   74FF         MOV     A,#-0x1
   \   0000F4   F0           MOVX    @DPTR,A
   \   0000F5   A3           INC     DPTR
   \   0000F6   F0           MOVX    @DPTR,A
    614            HalLedSet(HAL_LED_2, HAL_LED_MODE_ON);
   \   0000F7                ; Setup parameters for call to function HalLedSet
   \   0000F7   7A01         MOV     R2,#0x1
   \   0000F9   7902         MOV     R1,#0x2
   \   0000FB   12....       LCALL   ??HalLedSet?relay
    615            HalUARTWrite ( 0, "connect success, coor\n", 23);
   \   0000FE                ; Setup parameters for call to function HalUARTWrite
   \   0000FE   7C17         MOV     R4,#0x17
   \   000100   7D00         MOV     R5,#0x0
   \   000102   7A..         MOV     R2,#`?<Constant "connect success, coor\\n">` & 0xff
   \   000104   7B..         MOV     R3,#(`?<Constant "connect success, coor\\n">` >> 8) & 0xff
   \   000106   7900         MOV     R1,#0x0
   \   000108   12....       LCALL   ??HalUARTWrite?relay
    616          }
   \   00010B   741E         MOV     A,#0x1e
   \   00010D   12....       LCALL   ?DEALLOC_XSTACK8
   \   000110   02....       LJMP    ?Subroutine1 & 0xFFFF

   \                                 In  segment XDATA_ID, align 1, keep-with-next
   \                     `?<Initializer for SerialApp_epDesc>`:
   \   000000   01           DB 1
   \   000001   ....         DW SerialApp_TaskID
   \   000003   ....         DW SerialApp_SimpleDesc
   \   000005   00           DB 0

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??SerialApp_Init?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    SerialApp_Init

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??SerialApp_ProcessEvent?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    SerialApp_ProcessEvent

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??SerialApp_ProcessMSGCmd?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    SerialApp_ProcessMSGCmd

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??SerialApp_Send?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    SerialApp_Send

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??SerialApp_CallBack?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    SerialApp_CallBack

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??SerialApp_ConnectReqProcess?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    SerialApp_ConnectReqProcess

   \                                 In  segment XDATA_ROM_C, align 1
   \                     `?<Constant "SerialApp">`:
   \   000000   53657269     DB "SerialApp"
   \            616C4170
   \            7000    

   \                                 In  segment XDATA_ROM_C, align 1
   \                     `?<Constant {0}>`:
   \   000000   00           DB 0
   \   000001   00000000     DB 0, 0, 0, 0, 0, 0, 0, 0
   \            00000000
   \   000009   00000000     DB 0, 0, 0, 0, 0, 0, 0, 0
   \            00000000
   \   000011   00000000     DB 0, 0, 0, 0, 0, 0, 0, 0
   \            00000000
   \   000019   00000000     DB 0, 0, 0, 0, 0
   \            00      

   \                                 In  segment XDATA_ROM_C, align 1
   \                     `?<Constant "s:%d  c:%d  endpoint:...">`:
   \   000000   733A2564     DB "s:%d  c:%d  endpoint: %d\015\012"
   \            2020633A
   \            25642020
   \            656E6470
   \            6F696E74
   \            3A202564
   \            0D0A00  

   \                                 In  segment XDATA_ROM_C, align 1
   \                     `?<Constant "connect success, coor\\n">`:
   \   000000   636F6E6E     DB "connect success, coor\012"
   \            65637420
   \            73756363
   \            6573732C
   \            20636F6F
   \            720A00  

   Maximum stack usage in bytes:

     Function                       ISTACK PSTACK XSTACK
     --------                       ------ ------ ------
     SerialApp_CallBack                 0      0      9
       -> SerialApp_Send                0      0     18
     SerialApp_ConnectReqProcess        2      0     65
       -> NLME_GetShortAddr             0      0     84
       -> sprintf                       0      0     96
       -> strlen                        0      0     84
       -> HalUARTWrite                  0      0     84
       -> AF_DataRequest                0      0    102
       -> HalLedSet                     0      0     84
       -> HalUARTWrite                  0      0     84
     SerialApp_Init                     0      0     38
       -> afRegister                    0      0     76
       -> RegisterForKeys               0      0     76
       -> HalUARTOpen                   0      0     76
       -> HalLcdWriteString             0      0     76
       -> ZDO_RegisterForZDOMsg         0      0     76
       -> ZDO_RegisterForZDOMsg         0      0     76
     SerialApp_ProcessEvent             0      0     21
       -> SerialApp_Send                0      0     24
       -> HalLedSet                     0      0     24
       -> osal_msg_deallocate           0      0     24
       -> osal_msg_receive              0      0     24
       -> SerialApp_ProcessMSGCmd       0      0     24
       -> AF_DataRequest                0      0     42
       -> osal_set_event                0      0     24
       -> HalUARTWrite                  0      0     24
     SerialApp_ProcessMSGCmd            1      0     29
       -> osal_memcpy                   0      0     34
       -> osal_memcpy                   0      0     34
       -> osal_set_event                0      0     28
       -> osal_stop_timerEx             0      0     28
       -> osal_start_timerEx            0      0     28
       -> HalLedSet                     0      0     28
       -> SerialApp_ConnectReqProcess
                                        0      0     28
     SerialApp_Send                     0      0     31
       -> HalUARTRead                   0      0     20
       -> AF_DataRequest                0      0     38
       -> osal_set_event                0      0     20
       -> HalLedSet                     0      0     20


   Segment part sizes:

     Function/Label                         Bytes
     --------------                         -----
     SerialApp_ClusterList                     8
     SerialApp_SimpleDesc                     12
     SerialApp_epDesc                          6
     SampleApp_NwkState                        1
     SerialApp_TaskID                          1
     SerialApp_MsgID                           1
     SerialApp_TxAddr                         12
     SerialApp_TxSeq                           1
     SerialApp_TxBuf                          81
     SerialApp_TxLen                           1
     SerialApp_RxAddr                         12
     SerialApp_RxSeq                           1
     SerialApp_RspBuf                          4
     cB                                      414
     SerialApp_Init                          187
     ?Subroutine0                              5
     SerialApp_ProcessEvent                  263
     ?Subroutine1                              5
     SerialApp_ProcessMSGCmd                 317
     ?Subroutine4                             11
     ?Subroutine3                             10
     ?Subroutine2                             14
     SerialApp_Send                          132
     SerialApp_CallBack                       18
     SerialApp_ConnectReqProcess             275
     ?<Initializer for SerialApp_epDesc>       6
     ??SerialApp_Init?relay                    6
     ??SerialApp_ProcessEvent?relay            6
     ??SerialApp_ProcessMSGCmd?relay           6
     ??SerialApp_Send?relay                    6
     ??SerialApp_CallBack?relay                6
     ??SerialApp_ConnectReqProcess?relay       6
     ?<Constant "SerialApp">                  10
     ?<Constant {0}>                          30
     ?<Constant "s:%d  c:%d  endpoint:...">   27
     ?<Constant "connect success, coor\n">    23

 
 1 237 bytes in segment BANKED_CODE
    36 bytes in segment BANK_RELAYS
     6 bytes in segment XDATA_I
     6 bytes in segment XDATA_ID
   110 bytes in segment XDATA_ROM_C
   529 bytes in segment XDATA_Z
 
 1 279 bytes of CODE  memory
   110 bytes of CONST memory
   535 bytes of XDATA memory

Errors: none
Warnings: 4
